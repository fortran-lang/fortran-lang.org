
<!DOCTYPE html>

<html lang="None">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Getting started &#8212; Fortran-lang.org website 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
  
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <p>We briefly discussed the basics of <code class="docutils literal notranslate"><span class="pre">make</span></code>. This chapter gives ideas
and strategies to scale <code class="docutils literal notranslate"><span class="pre">make</span></code> for larger projects.</p>
<p>Before going into detail with <code class="docutils literal notranslate"><span class="pre">make</span></code>, consider a few points:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">make</span></code> is a Unix tool and might give you a hard time when porting to non-Unix
platforms. That said, there are also different flavors of <code class="docutils literal notranslate"><span class="pre">make</span></code> available,
not all might support the features you want to use.</p></li>
<li><p>While <code class="docutils literal notranslate"><span class="pre">make</span></code> gives you full control over the build process, it also
means you are responsible for the entire build process, and you have to specify the rules for every detail of your project.
You might find yourself spending a significant amount of time writing and
maintaining your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> instead of developing your source code.</p></li>
<li><p>You can work with your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, but think about other developers
on your project who may not be familiar with <code class="docutils literal notranslate"><span class="pre">make</span></code>. How much time do you expect them to spend learning your
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code> and would they be able to debug or add features?</p></li>
<li><p>Pure <code class="docutils literal notranslate"><span class="pre">make</span></code> will not scale. You will soon add auxiliary programs
to dynamically or statically generate your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. Those introduce
dependencies and possible sources of errors. The effort needed to test and document those
tools should not be underestimated.</p></li>
</ol>
<p>If you think <code class="docutils literal notranslate"><span class="pre">make</span></code> is suitable for your needs, than you can start writing
your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. For this course we will use real world examples from the
package index, which (at the time of writing) use build systems other
than <code class="docutils literal notranslate"><span class="pre">make</span></code>. This guide should present a general recommended style to write
<code class="docutils literal notranslate"><span class="pre">make</span></code>, but also serve as demonstration of useful and interesting features.</p>
<p>{% include tip.html content=&quot;Even if you find <code class="docutils literal notranslate"><span class="pre">make</span></code> unsuitable to build your project, it is <em>the</em> tool to automate workflows defined by files. Maybe you can leverage its power in a different context.&quot; %}</p>
<section id="getting-started">
<h1>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<p>For this part we will work with
<a href="https://github.com/jacobwilliams/fortran-csv-module/tree/1.2.0" target="_blank" rel="noopener"> the Fortran CSV module (v1.2.0)</a>.
Our goal is to write a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to compile this project to a static library.
Start by cloning the repository</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jacobwilliams</span><span class="o">/</span><span class="n">fortran</span><span class="o">-</span><span class="n">csv</span><span class="o">-</span><span class="n">module</span> <span class="o">-</span><span class="n">b</span> <span class="mf">1.2.0</span>
<span class="n">cd</span> <span class="n">fortran</span><span class="o">-</span><span class="n">csv</span><span class="o">-</span><span class="n">module</span>
</pre></div>
</div>
<p>{% include note.html content=&quot;For this part we will work with the code from tag <code class="docutils literal notranslate"><span class="pre">1.2.0</span></code>, to make it as reproducible as possible. Feel free to use the latest version or another project instead.&quot; %}</p>
<p>This project uses FoBiS as build system, and you can check the
<code class="docutils literal notranslate"><span class="pre">build.sh</span></code> for options used with FoBiS. We are about to write a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>
for this project. First, we check the directory structure and the source files</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.
├── build.sh
├── files
│   ├── test_2_columns.csv
│   └── test.csv
├── fortran-csv-module.md
├── LICENSE
├── README.md
└── src
    ├── csv_kinds.f90
    ├── csv_module.F90
    ├── csv_parameters.f90
    ├── csv_utilities.f90
    └── tests
        ├── csv_read_test.f90
        ├── csv_test.f90
        └── csv_write_test.f90
</pre></div>
</div>
<p>We find seven different Fortran source files; the four in <code class="docutils literal notranslate"><span class="pre">src</span></code> should
be compiled and added to a static library while the three in <code class="docutils literal notranslate"><span class="pre">src/tests</span></code>
contain individual programs that depend on this static library.</p>
<p>Start by creating a simple <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># Disable the default rules</span>
<span class="nv">MAKEFLAGS</span> <span class="o">+=</span> --no-builtin-rules --no-builtin-variables

<span class="c"># Project name</span>
<span class="nv">NAME</span> <span class="o">:=</span> csv

<span class="c"># Configuration settings</span>
<span class="nv">FC</span> <span class="o">:=</span> gfortran
<span class="nv">AR</span> <span class="o">:=</span> ar rcs
<span class="nv">LD</span> <span class="o">:=</span> <span class="k">$(</span>FC<span class="k">)</span>
<span class="nv">RM</span> <span class="o">:=</span> rm -f

<span class="c"># List of all source files</span>
<span class="nv">SRCS</span> <span class="o">:=</span> src/csv_kinds.f90 <span class="se">\</span>
        src/csv_module.F90 <span class="se">\</span>
        src/csv_parameters.f90 <span class="se">\</span>
        src/csv_utilities.f90
<span class="nv">TEST_SRCS</span> <span class="o">:=</span> src/tests/csv_read_test.f90 <span class="se">\</span>
             src/tests/csv_test.f90 <span class="se">\</span>
             src/tests/csv_write_test.f90

<span class="c"># Create lists of the build artefacts in this project</span>
<span class="nv">OBJS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .o, <span class="k">$(</span>SRCS<span class="k">))</span>
<span class="nv">TEST_OBJS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .o, <span class="k">$(</span>TEST_SRCS<span class="k">))</span>
<span class="nv">LIB</span> <span class="o">:=</span> <span class="k">$(</span>patsubst %, lib%.a, <span class="k">$(</span>NAME<span class="k">))</span>
<span class="nv">TEST_EXE</span> <span class="o">:=</span> <span class="k">$(</span>patsubst %.f90, %.exe, <span class="k">$(</span>TEST_SRCS<span class="k">))</span>

<span class="c"># Declare all public targets</span>
<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
<span class="nf">all</span><span class="o">:</span> <span class="k">$(</span><span class="nv">LIB</span><span class="k">)</span> <span class="k">$(</span><span class="nv">TEST_EXE</span><span class="k">)</span>

<span class="c"># Create the static library from the object files</span>
<span class="nf">$(LIB)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
	<span class="k">$(</span>AR<span class="k">)</span> <span class="nv">$@</span> $^

<span class="c"># Link the test executables</span>
<span class="nf">$(TEST_EXE)</span><span class="o">:</span> %.<span class="n">exe</span>: %.<span class="n">f</span>90.<span class="n">o</span> <span class="k">$(</span><span class="nv">LIB</span><span class="k">)</span>
	<span class="k">$(</span>LD<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="c"># Create object files from Fortran source</span>
<span class="nf">$(OBJS) $(TEST_OBJS)</span><span class="o">:</span> %.<span class="n">o</span>: %
	<span class="k">$(</span>FC<span class="k">)</span> -c -o <span class="nv">$@</span> $&lt;

<span class="c"># Define all module interdependencies</span>
<span class="nv">csv_kinds.mod</span> <span class="o">:=</span> src/csv_kinds.f90.o
<span class="nv">csv_module.mod</span> <span class="o">:=</span> src/csv_module.F90.o
<span class="nv">csv_parameters.mod</span> <span class="o">:=</span> src/csv_parameters.f90.o
<span class="nv">csv_utilities.mod</span> <span class="o">:=</span> src/csv_utilities.f90.o
<span class="nf">src/csv_module.F90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_utilities.mod</span><span class="k">)</span>
<span class="nf">src/csv_module.F90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">src/csv_module.F90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_parameters.mod</span><span class="k">)</span>
<span class="nf">src/csv_parameters.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">src/csv_utilities.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">src/csv_utilities.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_parameters.mod</span><span class="k">)</span>
<span class="nf">src/tests/csv_read_test.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>
<span class="nf">src/tests/csv_test.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>
<span class="nf">src/tests/csv_write_test.f90.o</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>

<span class="c"># Cleanup, filter to avoid removing source code by accident</span>
<span class="nf">clean</span><span class="o">:</span>
	<span class="k">$(</span>RM<span class="k">)</span> <span class="k">$(</span>filter %.o, <span class="k">$(</span>OBJS<span class="k">)</span> <span class="k">$(</span>TEST_OBJS<span class="k">))</span> <span class="k">$(</span>filter %.exe, <span class="k">$(</span>TEST_EXE<span class="k">))</span> <span class="k">$(</span>LIB<span class="k">)</span> <span class="k">$(</span>wildcard *.mod<span class="k">)</span>
</pre></div>
</div>
<p>Invoking <code class="docutils literal notranslate"><span class="pre">make</span></code> should build the static library and the test executables as
expected:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gfortran -c -o src/csv_kinds.f90.o src/csv_kinds.f90
gfortran -c -o src/csv_parameters.f90.o src/csv_parameters.f90
gfortran -c -o src/csv_utilities.f90.o src/csv_utilities.f90
gfortran -c -o src/csv_module.F90.o src/csv_module.F90
ar rcs libcsv.a src/csv_kinds.f90.o src/csv_module.F90.o src/csv_parameters.f90.o src/csv_utilities.f90.o
gfortran -c -o src/tests/csv_read_test.f90.o src/tests/csv_read_test.f90
gfortran -o src/tests/csv_read_test.exe src/tests/csv_read_test.f90.o libcsv.a
gfortran -c -o src/tests/csv_test.f90.o src/tests/csv_test.f90
gfortran -o src/tests/csv_test.exe src/tests/csv_test.f90.o libcsv.a
gfortran -c -o src/tests/csv_write_test.f90.o src/tests/csv_write_test.f90
gfortran -o src/tests/csv_write_test.exe src/tests/csv_write_test.f90.o libcsv.a
</pre></div>
</div>
<p>There are a few things to note there, a <code class="docutils literal notranslate"><span class="pre">make</span></code> build usually interlaces the
build artifacts and the source code, unless you put extra effort into implementing
a build directory.
Also, right now the the source files and dependencies are specified explicitly,
which results in several additional lines even for such a simple project.</p>
</section>
<section id="automatically-generated-dependencies">
<h1>Automatically generated dependencies<a class="headerlink" href="#automatically-generated-dependencies" title="Permalink to this headline">¶</a></h1>
<p>The main drawback of <code class="docutils literal notranslate"><span class="pre">make</span></code> for Fortran is the missing capability to
determine module dependencies. This is usually solved by either adding those
by hand or automatically scanning the source code with an external tool.
Some compilers (like the Intel Fortran compiler) also offer to generate dependencies in <code class="docutils literal notranslate"><span class="pre">make</span></code> format.</p>
<p>Before diving into the dependency generation, we will outline the concept of
a robust take on the dependency problem.
First, we want an approach that can process all source files independently,
while each source file provides (<code class="docutils literal notranslate"><span class="pre">module</span></code>) or requires (<code class="docutils literal notranslate"><span class="pre">use</span></code>) modules.
When generating the dependencies only the name of the source file and the
module files are known, and no information on the object file names should be
required.</p>
<p>If you check the dependency section above you will note that all dependencies are
defined between object files rather than source files. To change this, we can
generate a map from the source files their respective object files:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># Define a map from each file name to its object file</span>
<span class="nv">obj</span> <span class="o">=</span> <span class="k">$(</span>src<span class="k">)</span>.o
<span class="nf">$(foreach src, $(SRCS) $(TEST_SRCS), $(eval $(src) </span><span class="o">:</span>= <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>))
</pre></div>
</div>
<p>Note the declaration of <code class="docutils literal notranslate"><span class="pre">obj</span></code> as recursively expanded variable, we effectively
use this mechanism to define a function in <code class="docutils literal notranslate"><span class="pre">make</span></code>. The <code class="docutils literal notranslate"><span class="pre">foreach</span></code> function
allows us to loop over all source files, while the <code class="docutils literal notranslate"><span class="pre">eval</span></code> function allows us
to generate <code class="docutils literal notranslate"><span class="pre">make</span></code> statements and evaluate them for this <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>.</p>
<p>We adjust the dependencies accordingly as we can now define the name of the
object files through the source file names:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># Define all module interdependencies</span>
<span class="nv">csv_kinds.mod</span> <span class="o">:=</span> <span class="k">$(</span>src/csv_kinds.f90<span class="k">)</span>
<span class="nv">csv_module.mod</span> <span class="o">:=</span> <span class="k">$(</span>src/csv_module.F90<span class="k">)</span>
<span class="nv">csv_parameters.mod</span> <span class="o">:=</span> <span class="k">$(</span>src/csv_parameters.f90<span class="k">)</span>
<span class="nv">csv_utilities.mod</span> <span class="o">:=</span> <span class="k">$(</span>src/csv_utilities.f90<span class="k">)</span>
<span class="nf">$(src/csv_module.F90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_utilities.mod</span><span class="k">)</span>
<span class="nf">$(src/csv_module.F90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">$(src/csv_module.F90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_parameters.mod</span><span class="k">)</span>
<span class="nf">$(src/csv_parameters.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">$(src/csv_utilities.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_kinds.mod</span><span class="k">)</span>
<span class="nf">$(src/csv_utilities.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_parameters.mod</span><span class="k">)</span>
<span class="nf">$(src/tests/csv_read_test.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>
<span class="nf">$(src/tests/csv_test.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>
<span class="nf">$(src/tests/csv_write_test.f90)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">csv_module.mod</span><span class="k">)</span>
</pre></div>
</div>
<p>The same strategy of creating a map is already used for the module files, now
it is just expanded to the object files as well.</p>
<p>To generate the respective dependency map automatically we will use an
<code class="docutils literal notranslate"><span class="pre">awk</span></code> script here</p>
<div class="highlight-awk notranslate"><div class="highlight"><pre><span></span><span class="c1">#!/usr/bin/awk -f</span>

<span class="nb">BEGIN</span> <span class="p">{</span>
    <span class="c1"># Fortran is case insensitive, disable case sensitivity for matching</span>
    <span class="nb">IGNORECASE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="c1"># Match a module statement</span>
<span class="c1"># - the first argument ($1) should be the whole word module</span>
<span class="c1"># - the second argument ($2) should be a valid module name</span>
<span class="o">$</span><span class="mi">1</span> <span class="o">~</span> <span class="sr">/^module$/</span> <span class="o">&amp;&amp;</span>
<span class="o">$</span><span class="mi">2</span> <span class="o">~</span> <span class="sr">/^[a-zA-Z][a-zA-Z0-9_]*$/</span> <span class="p">{</span>
    <span class="c1"># count module names per file to avoid having modules twice in our list</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modc</span><span class="p">[</span><span class="nb">FILENAME</span><span class="p">,</span><span class="o">$</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># add to the module list, the generated module name is expected</span>
        <span class="c1"># to be lowercase, the FILENAME is the current source file</span>
        <span class="nx">mod</span><span class="p">[</span><span class="o">++</span><span class="nx">im</span><span class="p">]</span> <span class="o">=</span> <span class="kr">sprintf</span><span class="p">(</span><span class="s2">&quot;%s.mod = $(%s)&quot;</span><span class="p">,</span> <span class="kr">tolower</span><span class="p">(</span><span class="o">$</span><span class="mi">2</span><span class="p">),</span> <span class="nb">FILENAME</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Match a use statement</span>
<span class="c1"># - the first argument ($1) should be the whole word use</span>
<span class="c1"># - the second argument ($2) should be a valid module name</span>
<span class="o">$</span><span class="mi">1</span> <span class="o">~</span> <span class="sr">/^use$/</span> <span class="o">&amp;&amp;</span>
<span class="o">$</span><span class="mi">2</span> <span class="o">~</span> <span class="sr">/^[a-zA-Z][a-zA-Z0-9_]*,?$/</span> <span class="p">{</span>
    <span class="c1"># Remove a trailing comma from an optional only statement</span>
    <span class="kr">gsub</span><span class="p">(</span><span class="sr">/,/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">$</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># count used module names per file to avoid using modules twice in our list</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">usec</span><span class="p">[</span><span class="nb">FILENAME</span><span class="p">,</span><span class="o">$</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># add to the used modules, the generated module name is expected</span>
        <span class="c1"># to be lowercase, the FILENAME is the current source file</span>
        <span class="nx">use</span><span class="p">[</span><span class="o">++</span><span class="nx">iu</span><span class="p">]</span> <span class="o">=</span> <span class="kr">sprintf</span><span class="p">(</span><span class="s2">&quot;$(%s) += $(%s.mod)&quot;</span><span class="p">,</span> <span class="nb">FILENAME</span><span class="p">,</span> <span class="kr">tolower</span><span class="p">(</span><span class="o">$</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Match an include statement</span>
<span class="c1"># - the first argument ($1) should be the whole word include</span>
<span class="c1"># - the second argument ($2) can be everything, as long as delimited by quotes</span>
<span class="o">$</span><span class="mi">1</span> <span class="o">~</span> <span class="sr">/^(#:?)?include$/</span> <span class="o">&amp;&amp;</span>
<span class="o">$</span><span class="mi">2</span> <span class="o">~</span> <span class="sr">/^[&quot;&#39;].+[&quot;&#39;]$/</span> <span class="p">{</span>
    <span class="c1"># Remove quotes from the included file name</span>
    <span class="kr">gsub</span><span class="p">(</span><span class="sr">/&#39;|&quot;/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">$</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># count included files per file to avoid having duplicates in our list</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">incc</span><span class="p">[</span><span class="nb">FILENAME</span><span class="p">,</span><span class="o">$</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># Add the included file to our list, this might be case-sensitive</span>
        <span class="nx">inc</span><span class="p">[</span><span class="o">++</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="kr">sprintf</span><span class="p">(</span><span class="s2">&quot;$(%s) += $(%s)&quot;</span><span class="p">,</span> <span class="nb">FILENAME</span><span class="p">,</span> <span class="o">$</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Finally, produce the output for make, loop over all modules, use statements</span>
<span class="c1"># and include statements, empty lists are ignored in awk</span>
<span class="nb">END</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">in</span> <span class="nx">mod</span><span class="p">)</span> <span class="kr">print</span> <span class="nx">mod</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">in</span> <span class="nx">use</span><span class="p">)</span> <span class="kr">print</span> <span class="nx">use</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">in</span> <span class="nx">inc</span><span class="p">)</span> <span class="kr">print</span> <span class="nx">inc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This script makes a few assumptions about the source code it parses, so it will
not work with all Fortran code (namely submodules are not supported), but for
this example it will suffice.</p>
<p>{% capture note %}</p>
<p>The above script uses the <code class="docutils literal notranslate"><span class="pre">awk</span></code> language, which is designed for the purpose
of text stream processing and uses a C-like syntax. In <code class="docutils literal notranslate"><span class="pre">awk</span></code> you can define
groups which are evaluated on certain events, <em>e.g.</em> when a line matches a
specific pattern, usually expressed by a
<a href="https://en.wikipedia.org/wiki/Regular_expression" target="_blank" rel="noopener"> regular expression</a>.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">awk</span></code> script defines five groups, two of them use the special pattern
<code class="docutils literal notranslate"><span class="pre">BEGIN</span></code> and <code class="docutils literal notranslate"><span class="pre">END</span></code> which are run before the script starts and after the script
finishes, respectively.
Before the script starts we make the script case-insensitive since we are dealing
with Fortran source code here.
We also use the special variable <code class="docutils literal notranslate"><span class="pre">FILENAME</span></code> to determine which file we are
currently parsing and to allow processing multiple files at once.</p>
<p>With the three patterns defined we are looking for <code class="docutils literal notranslate"><span class="pre">module</span></code>, <code class="docutils literal notranslate"><span class="pre">use</span></code> and
<code class="docutils literal notranslate"><span class="pre">include</span></code> statements as the first space delimited entry. With the used
pattern not all valid Fortran code will be parsed correctly.
A failing example would be:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="kd">::</span><span class="n">my_module</span><span class="p">,</span><span class="k">only</span><span class="p">:</span><span class="n">proc</span><span class="w"></span>
</pre></div>
</div>
<p>To make this parsable by the <code class="docutils literal notranslate"><span class="pre">awk</span></code> script we can add another group directly
after the <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code> group, modifying the stream while processing it with</p>
<div class="highlight-awk notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="kr">gsub</span><span class="p">(</span><span class="sr">/,|:/</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In theory you would need a full Fortran parser to deal with continuation lines
and other difficulties. This might be possible to implement in <code class="docutils literal notranslate"><span class="pre">awk</span></code> but
would require a huge script in the end.</p>
<p>Also, keep in mind that generating the dependencies should be fast, an expensive
parser can produce a significant overhead when generating dependencies for a large
code base. Making reasonable assumptions can simplify and speed up this step, but
also introduces an error source in your build tools.</p>
<p>{% endcapture %}
{% include tip.html title=&quot;Using awk&quot; content=note %}</p>
<p>Make the script executable (<code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">gen-deps.awk</span></code>) and test it with
<code class="docutils literal notranslate"><span class="pre">./gen-deps.awk</span> <span class="pre">$(find</span> <span class="pre">src</span> <span class="pre">-name</span> <span class="pre">'*.[fF]90')</span></code>. You should see output like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>csv_utilities.mod = $(src/csv_utilities.f90)
csv_kinds.mod = $(src/csv_kinds.f90)
csv_parameters.mod = $(src/csv_parameters.f90)
csv_module.mod = $(src/csv_module.F90)
$(src/csv_utilities.f90) += $(csv_kinds.mod)
$(src/csv_utilities.f90) += $(csv_parameters.mod)
$(src/csv_kinds.f90) += $(iso_fortran_env.mod)
$(src/tests/csv_read_test.f90) += $(csv_module.mod)
$(src/tests/csv_read_test.f90) += $(iso_fortran_env.mod)
$(src/tests/csv_write_test.f90) += $(csv_module.mod)
$(src/tests/csv_write_test.f90) += $(iso_fortran_env.mod)
$(src/tests/csv_test.f90) += $(csv_module.mod)
$(src/tests/csv_test.f90) += $(iso_fortran_env.mod)
$(src/csv_parameters.f90) += $(csv_kinds.mod)
$(src/csv_module.F90) += $(csv_utilities.mod)
$(src/csv_module.F90) += $(csv_kinds.mod)
$(src/csv_module.F90) += $(csv_parameters.mod)
$(src/csv_module.F90) += $(iso_fortran_env.mod)
</pre></div>
</div>
<p>Note that the scripts output will use recursively expanded variables and not
define any dependencies yet, because out-of-order declaration of variables
might be necessary and we do not want to create any target by accident.
You can verify that the same information as in the above handwritten snippet is
present. The only exception is the additional dependency on the
<code class="docutils literal notranslate"><span class="pre">iso_fortran_env.mod</span></code>, since it is an undefined variable it will just expand
to an empty string and not introduce any further dependencies.</p>
<p>Now, you can finally include this piece in your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to automate the
dependency generation:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># Disable the default rules</span>
<span class="nv">MAKEFLAGS</span> <span class="o">+=</span> --no-builtin-rules --no-builtin-variables

<span class="c"># Project name</span>
<span class="nv">NAME</span> <span class="o">:=</span> csv

<span class="c"># Configuration settings</span>
<span class="nv">FC</span> <span class="o">:=</span> gfortran
<span class="nv">AR</span> <span class="o">:=</span> ar rcs
<span class="nv">LD</span> <span class="o">:=</span> <span class="k">$(</span>FC<span class="k">)</span>
<span class="nv">RM</span> <span class="o">:=</span> rm -f
<span class="nv">GD</span> <span class="o">:=</span> ./gen-deps.awk

<span class="c"># List of all source files</span>
<span class="nv">SRCS</span> <span class="o">:=</span> src/csv_kinds.f90 <span class="se">\</span>
        src/csv_module.F90 <span class="se">\</span>
        src/csv_parameters.f90 <span class="se">\</span>
        src/csv_utilities.f90
<span class="nv">TEST_SRCS</span> <span class="o">:=</span> src/tests/csv_read_test.f90 <span class="se">\</span>
             src/tests/csv_test.f90 <span class="se">\</span>
             src/tests/csv_write_test.f90

<span class="c"># Define a map from each file name to its object file</span>
<span class="nv">obj</span> <span class="o">=</span> <span class="k">$(</span>src<span class="k">)</span>.o
<span class="nf">$(foreach src, $(SRCS) $(TEST_SRCS), $(eval $(src) </span><span class="o">:</span>= <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>))

<span class="c"># Create lists of the build artefacts in this project</span>
<span class="nv">OBJS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .o, <span class="k">$(</span>SRCS<span class="k">))</span>
<span class="nv">DEPS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .d, <span class="k">$(</span>SRCS<span class="k">))</span>
<span class="nv">TEST_OBJS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .o, <span class="k">$(</span>TEST_SRCS<span class="k">))</span>
<span class="nv">TEST_DEPS</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .d, <span class="k">$(</span>TEST_SRCS<span class="k">))</span>
<span class="nv">LIB</span> <span class="o">:=</span> <span class="k">$(</span>patsubst %, lib%.a, <span class="k">$(</span>NAME<span class="k">))</span>
<span class="nv">TEST_EXE</span> <span class="o">:=</span> <span class="k">$(</span>patsubst %.f90, %.exe, <span class="k">$(</span>TEST_SRCS<span class="k">))</span>

<span class="c"># Declare all public targets</span>
<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
<span class="nf">all</span><span class="o">:</span> <span class="k">$(</span><span class="nv">LIB</span><span class="k">)</span> <span class="k">$(</span><span class="nv">TEST_EXE</span><span class="k">)</span>

<span class="c"># Create the static library from the object files</span>
<span class="nf">$(LIB)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
	<span class="k">$(</span>AR<span class="k">)</span> <span class="nv">$@</span> $^

<span class="c"># Link the test executables</span>
<span class="nf">$(TEST_EXE)</span><span class="o">:</span> %.<span class="n">exe</span>: %.<span class="n">f</span>90.<span class="n">o</span> <span class="k">$(</span><span class="nv">LIB</span><span class="k">)</span>
	<span class="k">$(</span>LD<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="c"># Create object files from Fortran source</span>
<span class="nf">$(OBJS) $(TEST_OBJS)</span><span class="o">:</span> %.<span class="n">o</span>: % <span class="p">|</span> %.<span class="n">d</span>
	<span class="k">$(</span>FC<span class="k">)</span> -c -o <span class="nv">$@</span> $&lt;

<span class="c"># Process the Fortran source for module dependencies</span>
<span class="nf">$(DEPS) $(TEST_DEPS)</span><span class="o">:</span> %.<span class="n">d</span>: %
	<span class="k">$(</span>GD<span class="k">)</span> $&lt; &gt; <span class="nv">$@</span>

<span class="c"># Define all module interdependencies</span>
<span class="cp">include $(DEPS) $(TEST_DEPS)</span>
<span class="nf">$(foreach dep, $(OBJS) $(TEST_OBJS), $(eval $(dep)</span><span class="o">:</span> <span class="k">$($(</span><span class="nv">dep</span><span class="k">))</span>))

<span class="c"># Cleanup, filter to avoid removing source code by accident</span>
<span class="nf">clean</span><span class="o">:</span>
	<span class="k">$(</span>RM<span class="k">)</span> <span class="k">$(</span>filter %.o, <span class="k">$(</span>OBJS<span class="k">)</span> <span class="k">$(</span>TEST_OBJS<span class="k">))</span> <span class="k">$(</span>filter %.d, <span class="k">$(</span>DEPS<span class="k">)</span> <span class="k">$(</span>TEST_DEPS<span class="k">))</span> <span class="k">$(</span>filter %.exe, <span class="k">$(</span>TEST_EXE<span class="k">))</span> <span class="k">$(</span>LIB<span class="k">)</span> <span class="k">$(</span>wildcard *.mod<span class="k">)</span>
</pre></div>
</div>
<p>Here additional dependency files are generated for each source file individually
and than included into the main <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>.
Also, the dependency files are added as dependency to the object files to ensure
they are generated before the object is compiled. The pipe character in
the dependencies defines an order of the rules without a timestamp dependency,
because it is not necessary to recompile an object file in case dependencies are
regenerated and potentially unchanged.</p>
<p>Again, we make use of the <code class="docutils literal notranslate"><span class="pre">eval</span></code> function to generate the dependencies in a
<code class="docutils literal notranslate"><span class="pre">foreach</span></code> loop over all object files. Note that we created a map between
the object files in the dependency files, expanding <code class="docutils literal notranslate"><span class="pre">dep</span></code> once yields the
object file name, expanding it again yields the object files it depends on.</p>
<p>Building your project with <code class="docutils literal notranslate"><span class="pre">make</span></code> should give an output similar to</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./gen-deps.awk src/csv_utilities.f90 &gt; src/csv_utilities.f90.d
./gen-deps.awk src/csv_parameters.f90 &gt; src/csv_parameters.f90.d
./gen-deps.awk src/csv_module.F90 &gt; src/csv_module.F90.d
./gen-deps.awk src/csv_kinds.f90 &gt; src/csv_kinds.f90.d
gfortran -c -o src/csv_kinds.f90.o src/csv_kinds.f90
gfortran -c -o src/csv_parameters.f90.o src/csv_parameters.f90
gfortran -c -o src/csv_utilities.f90.o src/csv_utilities.f90
gfortran -c -o src/csv_module.F90.o src/csv_module.F90
ar rcs libcsv.a src/csv_kinds.f90.o src/csv_module.F90.o src/csv_parameters.f90.o src/csv_utilities.f90.o
./gen-deps.awk src/tests/csv_read_test.f90 &gt; src/tests/csv_read_test.f90.d
gfortran -c -o src/tests/csv_read_test.f90.o src/tests/csv_read_test.f90
gfortran -o src/tests/csv_read_test.exe src/tests/csv_read_test.f90.o libcsv.a
./gen-deps.awk src/tests/csv_test.f90 &gt; src/tests/csv_test.f90.d
gfortran -c -o src/tests/csv_test.f90.o src/tests/csv_test.f90
gfortran -o src/tests/csv_test.exe src/tests/csv_test.f90.o libcsv.a
./gen-deps.awk src/tests/csv_write_test.f90 &gt; src/tests/csv_write_test.f90.d
gfortran -c -o src/tests/csv_write_test.f90.o src/tests/csv_write_test.f90
gfortran -o src/tests/csv_write_test.exe src/tests/csv_write_test.f90.o libcsv.a
</pre></div>
</div>
<p>Once the dependency files are generated, <code class="docutils literal notranslate"><span class="pre">make</span></code> will only update them if the
source changes and not require to rebuild them again for every invocation.</p>
<p>{% include tip.html content=&quot;With correct dependencies you can leverage parallel execution of your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, just use the <code class="docutils literal notranslate"><span class="pre">-j</span></code> flag to create multiple <code class="docutils literal notranslate"><span class="pre">make</span></code> processes.&quot; %}</p>
<p>Since dependencies can now be generated automatically, there is no need to specify
the source files explicitly, the <code class="docutils literal notranslate"><span class="pre">wildcard</span></code> function can be used to determine
them dynamically:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># List of all source files</span>
<span class="nv">SRCS</span> <span class="o">:=</span> <span class="k">$(</span>wildcard src/*.f90<span class="k">)</span> <span class="se">\</span>
        <span class="k">$(</span>wildcard src/*.F90<span class="k">)</span>
<span class="nv">TEST_SRCS</span> <span class="o">:=</span> <span class="k">$(</span>wildcard src/tests/*.f90<span class="k">)</span>
</pre></div>
</div>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Fortran-lang.org website</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../learn/index.html">Learn</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Fortran Community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/learn_website/building_programs/project_make.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>